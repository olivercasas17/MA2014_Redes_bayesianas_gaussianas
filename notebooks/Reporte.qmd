---
title: "Articulo"
format:
  html:
    toc: true
    html-math-method: katex
    embed-resources: true
    self-contained-math: true
    df-print: kable
editor: source
---

##Abstract

##Introduccion
Diversos estudios han demostrado que la exposicion cronica a contaminantes atmosfericos se asocia con un aumento en enfermedades respiratorias, cardiovasculares y metabolicas. Estos efectos usualmente se manifiestas en biomarcadores biologicos, los cuales permitan que se evalue de manera indirecta el impacto de los contaminante en la salud de las personas.\ 
Las redes bayesianas gaussianas nos permiten modelar las dependencias probabilisticas entre varaibles y generar representaciones graficas. En este caso, el uso de los datos provenientes de la encuesta nacional ENSANUT 2022, que ofrecen informacion detallada sobre muestras de sangre e informacion sociodemografica, ademas de informacion actualizada de la SEMARNAT sobre los contaminantes del aire, nos permitiran *plantear como hipotesis que los contaminantes atmosfericos tienen un efecto significativo sobre determinados biomarcadores de salud.* \ 
Comprender como interactuan factores ambientales con los biomarcadores de salud de la poblacion genera un impacto importante, ya que puede contribuir al diseno de politicas publicas orientadas a la prevencion y mitigacion de los efectos de la contaminacion atmosferica.
tbc..

##Metodologia
El trabajo sigue un enfoque cuantitativo, exploratorio, explicativo e interdisciplinario, analizando las relaciones que tienen contaminantes del aire con biomarcadores de salud en la poblacion, utilizando redes bayesianas gaussianas para representar estas relaciones de variables continuas.\ 

Inicialmente, se realizo una limpieza de la base de datos para extraer las variables con datos continuos relevantes para nuestro estudio, ademas de asegurarnos de que los datos estuvieran en un formato con el que pudieramos trabajar.\ 
Basandonos en informacion proporcionada por especialistas, se propusieron tres gráficos acíclicos dirigidos, por sus siglas en ingles DAGs, para posteriormente comparar las 3 DAGs con metricas estadisticas, y seleccionar la mejor de las tres para continuar con el analisis. \ 
Se incluyo la variable una variable categorica especifica, en este caso sexo, y con ayuda de los especialistas en el tema se escogieron tres queries nos llevarian a conclusiones prometedoras\ 

Las principales tecnicas que se utilizaron en este trabajo fueron: \ 
Análisis de redes bayesianas gaussianas, construyendo grafos acíclicos dirigidos para modelar relaciones de dependencia entre variables continuas\ 
Evaluacion de modelos, usando metodos estadisticos como el Criterio de Informacion de AKaike y el Criterio de Informacion Bayesiano, AIC y BIC por sus siglas en ingles.\ 
Inferencia probabilistica, consultas condicionales para estimar probabilidades bajo evidencia\ 

Los datos utilizados fueron los siguientes:\ 
data.csv\ 
data_F.csv\ 
data_M.csv\ 
Los datos crudos fueron recolectados de:\ 
calidad_aire_2025.csv\ 
ensanut2022_muestras.csv\ 
ensanut2022_socdem.csv\ 

Las herramientas que utilizamos fueron las siguientes:\ 
Lenguaje de programacion R\ 
Librerias: tidyverse, bnlearn, Rgraphviz\ 
Entorno de trabajo R Studio

##Aplicacion

```{r}
library(tidyverse)
library(bnlearn)
```

```{r}
data = read_csv("../data/data.csv") #ya que el oliver termine los datos
head(data)
```

```{r}
colnames(data) <- c("ALB", "HDL", "LDL", "CR", "GLU", "INS", "PCR", "TRI", "HB1AC", "EAG", "SO2", "CO", "NOx", "COV", "PM10", "PM2.5", "NH3")
```

```{r}
dag1 = empty.graph(nodes = c("ALB", "HDL", "LDL", "CR", "GLU", "INS", "PCR", "TRI", "HB1AC", "EAG", "SO2", "CO", "NOx", "COV", "PM10", "PM2.5", "NH3"))
```

```{r}
arc_set1 = matrix(c("TRI", "LDL",
                   "TRI", "HDL",
                   "INS", "LDL",
                   "INS", "HDL",
                   "GLU", "INS",
                   "GLU", "HB1AC",
                   "GLU", "PCR",
                   "GLU", "CR",
                   "INS", "CR",
                   "INS", "PCR",
                   "HB1AC", "EAG",
                   "HB1AC", "PCR",
                   "EAG", "PCR",
                   "CR", "ALB",
                   "SO2", "ALB",
                   "SO2", "PCR",
                   "CO", "CR",
                   "CO", "HB1AC",
                   "NOx", "TRI",
                   "COV", "GLU",
                   "PM10", "PCR",
                   "PM2.5", "GLU",
                   "NH3", "PCR",
                   "NH3", "ALB"), byrow = TRUE, ncol = 2,
                 dimnames = list(NULL, c("from", "to")))
```

```{r}
arcs(dag1) = arc_set1
```

```{r}
dag1
```

```{r}
graphviz.plot(dag1, shape = "ellipse")
```

```{r}
gbn1 = bn.fit(dag1, data = data)
```

```{r}
score_bic_dag1 = score(dag1, data = data, type = "bic-g")
score_bic_dag1
```

```{r}
score_aic_dag1 = score(dag1, data = data, type = "aic-g")
score_aic_dag1
```

DAG 2:

```{r}
dag2 = empty.graph(nodes = c("ALB", "HDL", "LDL", "TRI", "GLU", "INS", "PCR", 
                              "HB1AC", "EAG", "CR", 
                              "SO2", "CO", "NOx", "COV", "PM10", "PM2.5", "NH3"))

```

```{r}
arc_set2 = matrix(c(
  # --- Contaminantes -> PCR (inflamación)
  "SO2", "PCR",
  "NOx", "PCR",
  "COV", "PCR",
  "PM10", "PCR",
  "PM2.5", "PCR",
  "CO", "PCR",
  "NH3", "PCR",

  # --- PCR -> Albúmina (inflamación reduce albúmina)
  "PCR", "ALB",

  # --- NH3 y CO -> Creatinina (daño renal)
  "NH3", "CR",
  "CO", "CR",

  # --- Glucosa -> Insulina y HbA1c
  "GLU", "INS",
  "GLU", "HB1AC",

  # --- HbA1c -> Glucosa Promedio Estimada
  "HB1AC", "EAG",

  # --- Insulina -> lípidos
  "INS", "HDL",
  "INS", "LDL",
  "INS", "TRI",

  # --- Glucosa relacionada indirectamente con lípidos vía insulina
  # Relación ya cubierta arriba (GLU -> INS -> Lípidos)
  
  # --- PCR como indicador de inflamación sistémica (opcional conexión a GLU)
  "PCR", "GLU"
), byrow = TRUE, ncol = 2,
dimnames = list(NULL, c("from", "to")))
```

```{r}
# 3. Asignar arcos al grafo
arcs(dag2) = arc_set2
```

```{r}
# 4. Revisar estructura del DAG
dag2
```

```{r}
# 5. Graficar DAG
graphviz.plot(dag2, shape = "ellipse")
```

```{r}
gbn2 = bn.fit(dag2, data = data)
```

```{r}
score_bic_dag2 = score(dag2, data = data, type = "bic-g")
score_bic_dag2
```

```{r}
score_aic_dag2 = score(dag2, data = data, type = "aic-g")
score_aic_dag2
```

DAG 3:

```{r}
dag3 = empty.graph(nodes = c("ALB", "HDL", "LDL", "CR", "GLU",                                  "INS", "PCR", "TRI", "HB1AC", 
                             "EAG", "SO2", "CO", "NOx", "COV",                                  "PM10", "PM2.5", "NH3"))
```

```{r}
arc_set3 = matrix(c("SO2", "PCR",
                    "CO", "PCR",
                    "NOx", "PCR",
                    "COV", "PCR",
                    "PM10", "PCR",
                    "PM2.5", "PCR",
                    "NH3", "PCR",
                    "PCR", "ALB",
                    "PCR", "LDL",
                    "PCR", "HDL",
                    "PCR", "TRI",
                    "PCR", "CR",
                    "PM2.5", "GLU",
                    "CO", "GLU",
                    "GLU", "INS",
                    "GLU", "HB1AC",
                    "HB1AC", "EAG"), byrow = TRUE, ncol = 2,
                  dimnames = list(NULL, c("from", "to")))
```

```{r}
arcs(dag3) = arc_set3
```

```{r}
graphviz.plot(dag3, shape = "ellipse")
```


```{r}
gbn3 = bn.fit(dag3, data = data)
```

```{r}
score_bic_dag3 = score(dag3, data = data, type = "bic-g")
score_bic_dag3
```

```{r}
score_aic_dag3 = score(dag3, data = data, type = "aic-g")
score_aic_dag3
```

```{r}
#tabla con los scores de las dag para que se vea bonita la comparacion
tabla_scores <- data.frame(
  DAG = c("DAG1", "DAG2", "DAG3"),
  BIC = c(score_bic_dag1, score_bic_dag2, score_bic_dag3),
  AIC = c(score_aic_dag1, score_aic_dag2, score_aic_dag3)
)

tabla_scores

```
Podemos observar que la DAG1 es la presenta un menor error por lo que va a ser la que usaremos en el resto del analisis.


Una forma de agregar una variable categorica, en este caso sexo, a la red gaussiana seria recodificando la variable para volverla continua, o separar nuestra base de datos en una de hombres y una de mujeres, trabajarlas por separado, y ver como cambian las relaciones en ambas y comparar los resultados de las inferencias condicionales que realicemos, este metodo es el que realizaremos.

```{r}
data_M = read_csv("../data/data_M.csv")
data_F = read_csv("../data/data_F.csv")
colnames(data_M) <- c("ALB", "HDL", "LDL", "CR", "GLU", "INS", "PCR", "TRI", "HB1AC", "EAG", "SO2", "CO", "NOx", "COV", "PM10", "PM2.5", "NH3")
colnames(data_F) <- c("ALB", "HDL", "LDL", "CR", "GLU", "INS", "PCR", "TRI", "HB1AC", "EAG", "SO2", "CO", "NOx", "COV", "PM10", "PM2.5", "NH3")
```


```{r}
gbn_masc = bn.fit(dag1, data = data_M)
gbn_fem = bn.fit(dag1, data = data_F)
```

```{r}
colnames(data_F)
```


Queries:
1. Cual es la probabilidad de que una persona tenga los Trigliceridos saludables dado que estan expuestas a altos niveles de NOx
```{r}
cpquery(gbn1, event = (TRI < 200), evidence = (NOx > quantile(data$NOx, 0.8)), n=10^6)
```
Cual seria la probabilidad sin condicion?
```{r}
cpquery(gbn1, event = (TRI < 200), evidence = TRUE, n=10^6)
```

2. Cual es la probabilidad de que los niveles de glucosa sean saludables en mujeres expuestas a altos niveles niveles de COV y PM2.5?
```{r}
cpquery(gbn_fem, event = (GLU < 100), evidence = (COV > quantile(data$COV, 0.8) & PM2.5 > 500), n=10^6)
```
Cual seria la probabilidad sin condicion?
```{r}
cpquery(gbn_fem, event = (GLU < 100), evidence = TRUE, n=10^6)
```

3. Cual es la probabilidad de que un hombre tenga un valor saludable de hemoglobina glucosilada dado que estan expuestos a altos niveles de CO
```{r}
cpquery(gbn1, event = (HB1AC < 6), evidence = (CO > quantile(data$CO, 0.8)), n=10^6)
```
Cual seria la probabilidad sin condicion?
```{r}
cpquery(gbn1, event = (HB1AC < 6), evidence = TRUE, n=10^6)
```

En general podemos observa que las probabilidades cambian muy poco, por lo que podemos concluir que los contaminantes del aire no tienen impacto en los biomarcadores de las personas

Incluir modelos no parametricos puede ayudar a mejorar el BIC y el AIC si las relaciones entre los datos son no lineales o no gaussianas, ya que los modelos no parametricos permiten mas flexibilidad en las distribuciones condicionales lo que permite capturar relaciones no lineales.\ 
Sin embargo este acercamiento necesita una gran cantidad de datos para evitar un sobreajuste y suele ser mas dificil de interpretar.

##Conclusiones

##Referencias