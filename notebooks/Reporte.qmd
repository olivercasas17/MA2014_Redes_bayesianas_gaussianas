---
title: "Redes bayesianas gaussianas"
author:
  - name: "Oliver Arturo Casas Pontanillo | A01645764"
  - name: "Erik Abraham Jajan Díaz | A01644648"
  - name: "José Luis Santos Montaño | A01781721"
date: today
format:
  pdf:
    code-block-bg: true
    code-block-border-left: true
    code-block-wrap: true
    toc: true
    toc-depth: 3
    number-sections: true
    number-depth: 3
    fontsize: 11pt
    linestretch: 1.5
    geometry: margin=2.5cm
    papersize: a4
    fig-width: 6
    fig-height: 4
    fig-pos: "H"
    code-line-numbers: true
    keep-tex: true
    documentclass: article
    mainfont: Times New Roman
    monofont: Courier New
    sansfont: Arial
header-includes:
  - \usepackage{fvextra}
  - \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines=true,breakanywhere=true,commandchars=\\\{\}}
  - \RecustomVerbatimEnvironment{Verbatim}{Verbatim}{breaklines=true,breakanywhere=true,frame=single}
editor:
  source: true
  markdown:
    wrap: 72
---

https://github.com/olivercasas17/MA2014_Redes_bayesianas_gaussianas

## Abstract
Esta investigación examina las relaciones entre contaminantes atmosféricos y biomarcadores de salud mediante redes bayesianas gaussianas. Utilizando datos de ENSANUT 2022 y calidad del aire de SEMARNAT, se modelaron las dependencias entre siete contaminantes y diez biomarcadores sanguíneos. Se construyeron tres DAGs alternativos y se seleccionó el modelo óptimo mediante criterios AIC y BIC. Los resultados proporcionan evidencia cuantitativa del impacto de la contaminación atmosférica en biomarcadores metabólicos, lipídicos e inflamatorios, contribuyendo al diseño de políticas de salud ambiental.

## Introducción
Diversos estudios han demostrado que la exposición crónica a contaminantes atmosféricos se asocia con un aumento en enfermedades respiratorias, cardiovasculares y metabólicas. Estos efectos usualmente se manifiestan en biomarcadores biológicos, los cuales permiten que se evalúe de manera indirecta el impacto de los contaminantes en la salud de las personas.\ 
Las redes bayesianas gaussianas nos permiten modelar las dependencias probabilísticas entre variables y generar representaciones gráficas. En este caso, el uso de los datos provenientes de la encuesta nacional ENSANUT 2022, que ofrecen información detallada sobre muestras de sangre e información sociodemográfica, además de información actualizada de la SEMARNAT sobre los contaminantes del aire, nos permitirán *plantear como hipótesis que los contaminantes atmosféricos tienen un efecto significativo sobre determinados biomarcadores de salud.* \ 
Comprender cómo interactúan factores ambientales con los biomarcadores de salud de la población genera un impacto importante, ya que puede contribuir al diseño de políticas públicas orientadas a la prevención y mitigación de los efectos de la contaminación atmosférica.

## Metodología
El trabajo sigue un enfoque cuantitativo, exploratorio, explicativo e interdisciplinario, analizando las relaciones que tienen contaminantes del aire con biomarcadores de salud en la población, utilizando redes bayesianas gaussianas para representar estas relaciones de variables continuas.\ 
Inicialmente, se realizó una limpieza de la base de datos para extraer las variables con datos continuos relevantes para nuestro estudio, además de asegurarnos de que los datos estuvieran en un formato con el que pudiéramos trabajar.\ 
Basándonos en información proporcionada por especialistas, se propusieron tres gráficos acíclicos dirigidos, por sus siglas en inglés DAGs, para posteriormente comparar las 3 DAGs con métricas estadísticas, y seleccionar la mejor de las tres para continuar con el análisis. \ 
Se incluyó una variable categórica específica, en este caso sexo, y con ayuda de los especialistas en el tema se escogieron tres queries que nos llevarían a conclusiones prometedoras\ 
Las principales técnicas que se utilizaron en este trabajo fueron: \ 
Análisis de redes bayesianas gaussianas, construyendo grafos acíclicos dirigidos para modelar relaciones de dependencia entre variables continuas\ 
Evaluación de modelos, usando métodos estadísticos como el Criterio de Información de Akaike y el Criterio de Información Bayesiano, AIC y BIC por sus siglas en inglés.\ 
Inferencia probabilística, consultas condicionales para estimar probabilidades bajo evidencia\ 
Los datos utilizados fueron los siguientes:\ 
data.csv\ 
data_F.csv\ 
data_M.csv\ 
Los datos crudos fueron recolectados de:\ 
calidad_aire_2025.csv\ 
ensanut2022_muestras.csv\ 
ensanut2022_socdem.csv\ 
Las herramientas que utilizamos fueron las siguientes:\ 
Lenguaje de programación R\ 
Librerías: tidyverse, bnlearn, Rgraphviz\ 
Entorno de trabajo R Studio

## Aplicacion

```{r, echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(bnlearn)
```

```{r, echo=TRUE, message=FALSE, warning=FALSE}
data = read_csv("../data/data.csv")
head(data)
```

```{r}
colnames(data) <- c("ALB", "HDL", "LDL", "CR", "GLU", "INS", "PCR", "TRI", "HB1AC", "EAG", "SO2", "CO", "NOx", "COV", "PM10", "PM2.5", "NH3")
```

```{r}
dag1 = empty.graph(nodes = c("ALB", "HDL", "LDL", "CR", "GLU", "INS", "PCR", "TRI", "HB1AC", "EAG", "SO2", "CO", "NOx", "COV", "PM10", "PM2.5", "NH3"))
```

```{r}
arc_set1 = matrix(c("TRI", "LDL",
                   "TRI", "HDL",
                   "INS", "LDL",
                   "INS", "HDL",
                   "GLU", "INS",
                   "GLU", "HB1AC",
                   "GLU", "PCR",
                   "GLU", "CR",
                   "INS", "CR",
                   "INS", "PCR",
                   "HB1AC", "EAG",
                   "HB1AC", "PCR",
                   "EAG", "PCR",
                   "CR", "ALB",
                   "SO2", "ALB",
                   "SO2", "PCR",
                   "CO", "CR",
                   "CO", "HB1AC",
                   "NOx", "TRI",
                   "COV", "GLU",
                   "PM10", "PCR",
                   "PM2.5", "GLU",
                   "NH3", "PCR",
                   "NH3", "ALB"), byrow = TRUE, ncol = 2,
                 dimnames = list(NULL, c("from", "to")))
```

```{r}
arcs(dag1) = arc_set1
```

```{r}
graphviz.plot(dag1, shape = "ellipse")
```

```{r}
gbn1 = bn.fit(dag1, data = data)
```

```{r}
score_bic_dag1 = score(dag1, data = data, type = "bic-g")
score_bic_dag1
```

```{r}
score_aic_dag1 = score(dag1, data = data, type = "aic-g")
score_aic_dag1
```

DAG 2:

```{r}
dag2 = empty.graph(nodes = c("ALB", "HDL", "LDL", "TRI", "GLU", "INS", "PCR", 
                              "HB1AC", "EAG", "CR", 
                              "SO2", "CO", "NOx", "COV", "PM10", "PM2.5", "NH3"))

```

```{r}
arc_set2 = matrix(c("SO2", "PCR",
                    "NOx", "PCR",
                    "COV", "PCR",
                    "PM10", "PCR",
                    "PM2.5", "PCR",
                    "CO", "PCR",
                    "NH3", "PCR",
                    "PCR", "ALB",
                    "NH3", "CR",
                    "CO", "CR",
                    "GLU", "INS",
                    "GLU", "HB1AC",
                    "HB1AC", "EAG",
                    "INS", "HDL",
                    "INS", "LDL",
                    "INS", "TRI",
                    "PCR", "GLU"), byrow = TRUE, ncol = 2,
                  dimnames = list(NULL, c("from", "to")))
```

```{r}
arcs(dag2) = arc_set2
```

```{r}
graphviz.plot(dag2, shape = "ellipse")
```

```{r}
gbn2 = bn.fit(dag2, data = data)
```

```{r}
score_bic_dag2 = score(dag2, data = data, type = "bic-g")
score_bic_dag2
```

```{r}
score_aic_dag2 = score(dag2, data = data, type = "aic-g")
score_aic_dag2
```

DAG 3:

```{r}
dag3 = empty.graph(nodes = c("ALB", "HDL", "LDL", "CR", "GLU",                                  "INS", "PCR", "TRI", "HB1AC", 
                             "EAG", "SO2", "CO", "NOx", "COV",                                  "PM10", "PM2.5", "NH3"))
```

```{r}
arc_set3 = matrix(c("SO2", "PCR",
                    "CO", "PCR",
                    "NOx", "PCR",
                    "COV", "PCR",
                    "PM10", "PCR",
                    "PM2.5", "PCR",
                    "NH3", "PCR",
                    "PCR", "ALB",
                    "PCR", "LDL",
                    "PCR", "HDL",
                    "PCR", "TRI",
                    "PCR", "CR",
                    "PM2.5", "GLU",
                    "CO", "GLU",
                    "GLU", "INS",
                    "GLU", "HB1AC",
                    "HB1AC", "EAG"), byrow = TRUE, ncol = 2,
                  dimnames = list(NULL, c("from", "to")))
```

```{r}
arcs(dag3) = arc_set3
```

```{r}
graphviz.plot(dag3, shape = "ellipse")
```

```{r}
gbn3 = bn.fit(dag3, data = data)
```

```{r}
score_bic_dag3 = score(dag3, data = data, type = "bic-g")
score_bic_dag3
```

```{r}
score_aic_dag3 = score(dag3, data = data, type = "aic-g")
score_aic_dag3
```

```{r}
#tabla con los scores de las dag para que se vea bonita la comparacion
tabla_scores <- data.frame(
  DAG = c("DAG1", "DAG2", "DAG3"),
  BIC = c(score_bic_dag1, score_bic_dag2, score_bic_dag3),
  AIC = c(score_aic_dag1, score_aic_dag2, score_aic_dag3)
)

tabla_scores

```
Podemos observar que la DAG1 es la que presenta un menor error por lo que va a ser la que usaremos en el resto del análisis.
Una forma de agregar una variable categórica, en este caso sexo, a la red gaussiana sería recodificando la variable para volverla continua, o separar nuestra base de datos en una de hombres y una de mujeres, trabajarlas por separado, y ver cómo cambian las relaciones en ambas y comparar los resultados de las inferencias condicionales que realicemos, este método es el que realizaremos.

```{r, echo=TRUE, message=FALSE, warning=FALSE}
data_M = read_csv("../data/data_M.csv")
data_F = read_csv("../data/data_F.csv")
colnames(data_M) <- c("ALB", "HDL", "LDL", "CR", "GLU", "INS", "PCR", "TRI", "HB1AC", "EAG", "SO2", "CO", "NOx", "COV", "PM10", "PM2.5", "NH3")
colnames(data_F) <- c("ALB", "HDL", "LDL", "CR", "GLU", "INS", "PCR", "TRI", "HB1AC", "EAG", "SO2", "CO", "NOx", "COV", "PM10", "PM2.5", "NH3")
```

```{r}
gbn_masc = bn.fit(dag1, data = data_M)
gbn_fem = bn.fit(dag1, data = data_F)
```

Queries:
1. ¿Cuál es la probabilidad de que una persona tenga los triglicéridos saludables dado que están expuestas a altos niveles de NOx?
```{r}
cpquery(gbn1, event = (TRI < 200), evidence = (NOx > quantile(data$NOx, 0.8)), n=10^6)
```

¿Cuál sería la probabilidad sin condición?
```{r}
cpquery(gbn1, event = (TRI < 200), evidence = TRUE, n=10^6)
```

2. ¿Cuál es la probabilidad de que los niveles de glucosa sean saludables en mujeres expuestas a altos niveles de COV y PM2.5?
```{r}
cpquery(gbn_fem, event = (GLU < 100), evidence = (COV > quantile(data$COV, 0.8) & PM2.5 > 500), n=10^6)
```

¿Cuál sería la probabilidad sin condición?
```{r}
cpquery(gbn_fem, event = (GLU < 100), evidence = TRUE, n=10^6)
```

3. Cual es la probabilidad de que un hombre tenga un valor saludable de hemoglobina glucosilada dado que estan expuestos a altos niveles de CO
```{r}
cpquery(gbn1, event = (HB1AC < 6), evidence = (CO > quantile(data$CO, 0.8)), n=10^6)
```
¿Cuál sería la probabilidad sin condición?
```{r}
cpquery(gbn1, event = (HB1AC < 6), evidence = TRUE, n=10^6)
```

En general podemos observar que las probabilidades cambian muy poco, por lo que podemos concluir que los contaminantes del aire no tienen impacto en los biomarcadores de las personas.

Incluir modelos no paramétricos puede ayudar a mejorar el BIC y el AIC si las relaciones entre los datos son no lineales o no gaussianas, ya que los modelos no paramétricos permiten más flexibilidad en las distribuciones condicionales, lo que permite capturar relaciones no lineales.

Sin embargo, este acercamiento necesita una gran cantidad de datos para evitar un sobreajuste y suele ser más difícil de interpretar.

## Conclusiones
Se construyeron tres modelos (DAGs) y, mediante los criterios AIC y BIC, se seleccionó la estructura más adecuada. Sin embargo, los resultados de las consultas condicionales mostraron que los cambios en la probabilidad de presentar biomarcadores saludables ante altos niveles de contaminantes fueron mínimos. Esto sugiere que, bajo los supuestos del modelo, los contaminantes no presentan un impacto directo fuerte sobre los biomarcadores analizados.

Una posible explicación es la limitación de las redes gaussianas, que asumen relaciones lineales y distribuciones normales, lo cual puede no reflejar la complejidad real de las interacciones entre contaminación y salud. Para futuros trabajos, se recomienda el uso de modelos no paramétricos o híbridos, así como bases de datos más amplias que incluyan variables contextuales como hábitos de vida y condiciones socioeconómicas. Aunque no se encontraron efectos significativos, la metodología implementada constituye una base sólida para estudios posteriores y puede convertirse en una herramienta útil para el diseño de políticas públicas orientadas a la prevención de enfermedades relacionadas con la contaminación.

## Referencias
https://www.jstatsoft.org/article/view/v035i03
